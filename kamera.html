<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HP Kamera (Realtime Remote)</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  body{margin:0;font-family:Arial;background:#0b1220;color:#fff}
  header{padding:14px 16px;background:#111b33;font-weight:700}
  .wrap{padding:14px;max-width:900px;margin:auto}
  video{width:100%;border-radius:14px;background:#000}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button,input{
    padding:12px 14px;border:0;border-radius:12px;width:100%;
    background:#2a5bff;color:#fff;font-weight:700
  }
  button.secondary{background:#2b3248}
  button.danger{background:#ff3b3b}
  .card{background:#111b33;border-radius:14px;padding:12px;margin-top:12px}
  .ok{color:#7CFF9C}
  a{color:#9db6ff}
  img{width:100%;border-radius:14px;margin-top:10px;display:none}
</style>
</head>
<body>
<header>üì∑ HP KAMERA (Realtime Remote)</header>

<div class="wrap">
  <div class="card">
    <b>PIN Room</b>
    <input id="pin" placeholder="contoh: 1234" value="1234"/>
    <div class="row">
      <button id="btnJoin">‚úÖ JOIN ROOM</button>
      <button id="btnLeave" class="secondary">üö™ LEAVE</button>
    </div>
    <div id="status" style="margin-top:8px;opacity:.9"></div>
  </div>

  <video id="video" autoplay playsinline></video>

  <div class="card">
    <b>Hasil Foto</b>
    <img id="photo" />
    <a id="downloadPhoto" download="foto.jpg" style="display:none;">‚¨áÔ∏è Download Foto</a>
  </div>

  <div class="card">
    <b>Hasil Video</b>
    <video id="videoResult" controls style="width:100%;border-radius:14px;background:#000;display:none"></video>
    <a id="downloadVideo" download="video.webm" style="display:none;">‚¨áÔ∏è Download Video</a>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
  // ‚úÖ firebaseConfig dari project kamu
  const firebaseConfig = {
    apiKey: "AIzaSyBfNXj8JXz8hVMgQm2HY0YSyYv-aO75OAw",
    authDomain: "camera-3547b.firebaseapp.com",
    databaseURL: "https://camera-3547b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "camera-3547b",
    storageBucket: "camera-3547b.appspot.com",
    messagingSenderId: "436520969909",
    appId: "1:436520969909:web:f4ab1cef0b53bbed7940fc"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const photo = document.getElementById("photo");
  const downloadPhoto = document.getElementById("downloadPhoto");

  const videoResult = document.getElementById("videoResult");
  const downloadVideo = document.getElementById("downloadVideo");

  const statusEl = document.getElementById("status");

  let stream = null;
  let track = null;
  let roomRef = null;
  let useFront = false;

  let mediaRecorder = null;
  let chunks = [];

  function setStatus(html){ statusEl.innerHTML = html; }

  async function startCamera() {
    stopCamera();
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: useFront ? "user" : "environment" },
      audio: true
    });
    video.srcObject = stream;
    track = stream.getVideoTracks()[0];
  }

  function stopCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    track = null;
    video.srcObject = null;
  }

  function takePhoto() {
    if (!video.videoWidth) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
    photo.src = dataUrl;
    photo.style.display = "block";

    downloadPhoto.href = dataUrl;
    downloadPhoto.style.display = "inline-block";
  }

  async function switchCamera() {
    useFront = !useFront;
    await startCamera();
  }

  function startRecording() {
    if (!stream) return;

    chunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) chunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      videoResult.src = url;
      videoResult.style.display = "block";
      downloadVideo.href = url;
      downloadVideo.style.display = "inline-block";
    };

    mediaRecorder.start();
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
  }

  async function setTorch(on) {
    if (!track || !track.applyConstraints) return;
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if (!caps.torch) return;
    try {
      await track.applyConstraints({ advanced: [{ torch: !!on }] });
    } catch (e) {}
  }

  function resetCmd() {
    if (roomRef) roomRef.child("cmd").set("");
  }

  async function joinRoom() {
    const pin = document.getElementById("pin").value.trim();
    if (!pin) return alert("Isi PIN dulu");

    roomRef = db.ref("rooms/" + pin);

    await roomRef.child("camera_online").set(true);
    await roomRef.child("last_seen").set(Date.now());

    setStatus(`‚úÖ Kamera join room: <span class="ok"><b>${pin}</b></span>`);

    await startCamera();

    roomRef.child("cmd").on("value", async (snap) => {
      const cmd = snap.val();
      if (!cmd) return;

      if (cmd === "SHOT") takePhoto();
      if (cmd === "SWITCH") await switchCamera();
      if (cmd === "REC_START") startRecording();
      if (cmd === "REC_STOP") stopRecording();
      if (cmd === "TORCH_ON") await setTorch(true);
      if (cmd === "TORCH_OFF") await setTorch(false);

      resetCmd();
    });
  }

  async function leaveRoom() {
    stopRecording();
    stopCamera();
    if (roomRef) {
      await roomRef.child("camera_online").set(false);
      roomRef.child("cmd").off();
      roomRef = null;
    }
    setStatus("üö™ Keluar room.");
  }

  document.getElementById("btnJoin").onclick = joinRoom;
  document.getElementById("btnLeave").onclick = leaveRoom;

  window.addEventListener("beforeunload", async () => {
    try {
      if (roomRef) await roomRef.child("camera_online").set(false);
    } catch(e) {}
  });
</script>

</body>
</html>