<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HP KAMERA (Realtime Remote)</title>

  <!-- Firebase compat (biar gampang) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body{margin:0;font-family:Arial;background:#0b1220;color:#fff}
    header{padding:14px 16px;background:#111b33;font-weight:700}
    .wrap{padding:14px;max-width:900px;margin:auto}
    video{width:100%;border-radius:14px;background:#000}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button,input{padding:12px 14px;border:0;border-radius:12px;width:100%}
    button{background:#2a5bff;color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#2b3248}
    button.danger{background:#ff3b3b}
    .card{background:#111b33;border-radius:14px;padding:12px;margin-top:12px}
    .ok{color:#7CFF9C}
    .warn{color:#FFD966}
    a{color:#9bd6ff}
  </style>
</head>
<body>
  <header>üì∑ HP KAMERA (Realtime Remote)</header>

  <div class="wrap">
    <div class="card">
      <b>PIN Room</b>
      <input id="pin" placeholder="contoh: 1234" value="1234" />
      <div class="row">
        <button id="btnJoin">‚úÖ JOIN ROOM</button>
        <button id="btnLeave" class="secondary">üö™ LEAVE</button>
      </div>
      <div id="status" style="margin-top:10px;opacity:.9">Belum join</div>
    </div>

    <div class="card">
      <video id="video" autoplay playsinline muted></video>
      <div class="row">
        <button id="btnStartCam">üé• START KAMERA</button>
        <button id="btnSwitch" class="secondary">üîÅ SWITCH</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnShot">üì∏ FOTO</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnRec" class="danger">‚è∫Ô∏è REKAM</button>
        <button id="btnStop" class="secondary">‚èπÔ∏è STOP</button>
      </div>
      <div style="margin-top:10px;opacity:.9">
        Rekaman tersimpan <b>lokal di HP ini</b> (browser download / galeri).
      </div>
    </div>
  </div>

<script>
  // =========================
  // üî• FIREBASE CONFIG (ISI PUNYA KAMU)
  // =========================
  const firebaseConfig = {
    apiKey: "ISI_APIKEY_KAMU",
    authDomain: "ISI_AUTHDOMAIN_KAMU",
    databaseURL: "ISI_DATABASEURL_KAMU",
    projectId: "ISI_PROJECTID_KAMU",
    storageBucket: "ISI_STORAGEBUCKET_KAMU",
    messagingSenderId: "ISI_MESSAGINGSENDERID_KAMU",
    appId: "ISI_APPID_KAMU"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // =========================
  // ELEMENTS
  // =========================
  const videoEl = document.getElementById("video");
  const pinEl = document.getElementById("pin");
  const statusEl = document.getElementById("status");

  let roomRef = null;
  let stream = null;
  let useFront = false;

  // rekam
  let mediaRecorder = null;
  let chunks = [];

  function setStatus(html){
    statusEl.innerHTML = html;
  }

  function getPin(){
    return pinEl.value.trim();
  }

  function sendCmd(cmd){
    if(!roomRef) return alert("JOIN ROOM dulu!");
    roomRef.child("cmd").set(cmd);
    roomRef.child("last_remote").set(Date.now());
  }

  async function startCamera(){
    try{
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: useFront ? "user" : "environment" },
        audio: true
      });

      videoEl.srcObject = stream;

      if(roomRef){
        roomRef.child("camera_online").set(true);
        roomRef.child("camera_last_seen").set(Date.now());
      }

      setStatus("‚úÖ Kamera ON");
    }catch(e){
      setStatus("‚ùå Kamera gagal: " + e.message);
    }
  }

  async function takePhoto(){
    if(!stream) return alert("Kamera belum ON!");
    // hanya trigger command biar remote tahu
    sendCmd("SHOT");
    alert("‚úÖ Foto diambil (fitur simpan foto otomatis butuh upgrade lanjut).");
  }

  function startRecord(){
    if(!stream) return alert("Kamera belum ON!");
    try{
      chunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      mediaRecorder.ondataavailable = (e) => {
        if(e.data && e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);

        // auto download
        const a = document.createElement("a");
        a.href = url;
        a.download = "rekaman_" + getPin() + "_" + Date.now() + ".webm";
        document.body.appendChild(a);
        a.click();
        a.remove();

        setStatus("‚úÖ Rekaman selesai & tersimpan ke HP (Download)");
      };

      mediaRecorder.start();
      setStatus("‚è∫Ô∏è Sedang merekam...");
    }catch(e){
      setStatus("‚ùå Rekam gagal: " + e.message);
    }
  }

  function stopRecord(){
    if(mediaRecorder && mediaRecorder.state !== "inactive"){
      mediaRecorder.stop();
    }
  }

  // =========================
  // JOIN / LEAVE
  // =========================
  document.getElementById("btnJoin").onclick = () => {
    const pin = getPin();
    if(!pin) return alert("Isi PIN dulu");

    roomRef = db.ref("rooms/" + pin);

    roomRef.child("camera_online").set(true);
    roomRef.child("camera_last_seen").set(Date.now());

    // dengarkan perintah remote
    roomRef.child("cmd").on("value", (s) => {
      const cmd = s.val();
      if(!cmd) return;

      if(cmd === "SWITCH"){
        useFront = !useFront;
        startCamera();
      }
      if(cmd === "SHOT"){
        // bisa nanti upgrade auto simpan foto
      }
      if(cmd === "REC_START"){
        startRecord();
      }
      if(cmd === "REC_STOP"){
        stopRecord();
      }
      if(cmd === "TORCH_ON"){
        alert("Torch ON belum support semua HP via browser.");
      }
      if(cmd === "TORCH_OFF"){
        alert("Torch OFF belum support semua HP via browser.");
      }
    });

    setStatus(`‚úÖ JOIN room <b class="ok">${pin}</b>`);
  };

  document.getElementById("btnLeave").onclick = () => {
    if(roomRef){
      roomRef.child("camera_online").set(false);
      roomRef.off();
      roomRef = null;
    }
    setStatus("üö™ Keluar room");
  };

  // =========================
  // BUTTONS
  // =========================
  document.getElementById("btnStartCam").onclick = startCamera;
  document.getElementById("btnSwitch").onclick = () => {
    useFront = !useFront;
    startCamera();
  };
  document.getElementById("btnShot").onclick = takePhoto;
  document.getElementById("btnRec").onclick = () => sendCmd("REC_START");
  document.getElementById("btnStop").onclick = () => sendCmd("REC_STOP");
</script>

</body>
</html>